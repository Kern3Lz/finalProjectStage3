/*
 * ============================================================
 * SMART CAGE - ML INTEGRATED (SIC Phase 3)
 * ESP32 + DHT11 + MQ2 Gas Sensor + MQTT + ML Prediction
 * ============================================================
 * 
 * FLOW:
 * 1. ESP32 baca sensor (DHT11 + MQ2)
 * 2. Publish data ke MQTT topics terpisah
 * 3. Dashboard ML terima data → Predict kondisi
 * 4. Dashboard publish prediksi ke prediction topics
 * 5. ESP32 subscribe predictions → Trigger output
 * 
 * OUTPUT DHT11 (Suhu/Kelembapan):
 * - Ideal  → LED Hijau ON, Relay OFF (kipas nyala)
 * - Panas  → LED Merah kedip, Buzzer ON, Relay OFF
 * - Dingin → LED Kuning kedip, Buzzer ON, Relay ON
 * 
 * OUTPUT MQ2 (Gas):
 * - Aman    → LED Hijau ON (MQ2 LOW)
 * - Waspada → LED Kuning kedip, Buzzer beep (MQ2 HIGH)
 * - Bahaya  → LED Merah cepat, Buzzer continuous (MQ2 HIGH + Suhu > 55°C)
 * ============================================================
 */

#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <DHT.h>
#include <WiFi.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>
#include <ESP32Servo.h>

// -------------------------
// LOGO GUNADARMA BITMAP (128x64px)
// -------------------------
const unsigned char epd_bitmap_gunadarma [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x4e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x73, 0x13, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc8, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x40, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x4c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1a, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68, 0x21, 0x43, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xa1, 0xc6, 0x82, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x40, 0xe1, 0x43, 0x08, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x88, 0x41, 0x61, 0x88, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x20, 0x70, 0x07, 0x18, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x34, 0x43, 0xf0, 0x10, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x1c, 0x3f, 0xff, 0x10, 0xc5, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x51, 0x04, 0xff, 0xff, 0xc1, 0x82, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xa3, 0x83, 0xff, 0xff, 0xe3, 0x01, 0x60, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0xc7, 0xfe, 0x0f, 0xf8, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x4f, 0xf8, 0x03, 0xfc, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x08, 0x1f, 0xf8, 0x70, 0xfe, 0x6c, 0x28, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x04, 0x06, 0x3f, 0xf0, 0xfc, 0x06, 0x18, 0x14, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0a, 0x1c, 0x3b, 0xe0, 0x7f, 0xff, 0x30, 0x06, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x08, 0x79, 0x80, 0x00, 0x3f, 0xa0, 0x02, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x71, 0x00, 0x7d, 0x07, 0x80, 0x02, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0xf3, 0x10, 0x31, 0xff, 0xc3, 0x02, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x40, 0xfb, 0x55, 0x95, 0xcf, 0xcb, 0x82, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x09, 0xff, 0xdd, 0xfd, 0xcd, 0xca, 0x82, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x08, 0x05, 0xf7, 0xfb, 0xff, 0xff, 0xee, 0x02, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x08, 0x7d, 0xfb, 0xfb, 0xb6, 0xfe, 0xe0, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x08, 0x09, 0xff, 0xff, 0xfd, 0xc3, 0xe0, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0xff, 0xff, 0xf7, 0xff, 0xe0, 0x0e, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0c, 0x01, 0xfe, 0x8b, 0xf9, 0x7f, 0xe0, 0x04, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x06, 0x01, 0xff, 0x60, 0x0c, 0xff, 0xe0, 0x04, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x06, 0x39, 0xff, 0xe0, 0x01, 0xff, 0xe3, 0x04, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x04, 0x79, 0xff, 0xe0, 0x0f, 0xff, 0xe7, 0x94, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x04, 0x39, 0xff, 0xf4, 0x0f, 0xff, 0xe7, 0x98, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x39, 0xff, 0xfc, 0x3f, 0xff, 0xc3, 0x08, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0xff, 0xfe, 0x7f, 0xff, 0xc0, 0x08, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0xff, 0xff, 0x7f, 0xff, 0xc0, 0x28, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x04, 0x7f, 0xfe, 0x3f, 0xff, 0x80, 0x10, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x9e, 0x7f, 0xfe, 0xff, 0xff, 0x98, 0x10, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x10, 0x3f, 0xff, 0x7f, 0xff, 0x1f, 0x50, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x84, 0x3f, 0xfe, 0x7f, 0xfe, 0x0c, 0x20, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xdc, 0x1f, 0xff, 0x7f, 0xfc, 0x04, 0x20, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x8f, 0xff, 0x7f, 0xf8, 0x40, 0xe0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xe1, 0x87, 0xff, 0xbf, 0xf0, 0x60, 0x40, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x43, 0x01, 0xfe, 0x3f, 0xe1, 0xf9, 0x40, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x40, 0xff, 0x7f, 0x81, 0xd0, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x21, 0x8c, 0x3f, 0xfe, 0x00, 0x82, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x04, 0x03, 0xe0, 0x18, 0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x16, 0x00, 0x00, 0x3c, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x24, 0x30, 0x02, 0x16, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x04, 0x61, 0xc3, 0x1a, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0xe1, 0x41, 0x08, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x01, 0x21, 0x61, 0x80, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x80, 0x23, 0x40, 0x80, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x10, 0x03, 0xc0, 0x02, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf1, 0xc0, 0x00, 0x61, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x80, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// -------------------------
// LOGO SIC BITMAP (128x64px)
// -------------------------
const unsigned char epd_bitmap_sic [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0xff, 0xfe, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x27, 0x00, 0x01, 0xcc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x98, 0x00, 0x00, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x0c, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x80, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x1a, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x40, 0x00, 0x00, 0x00, 0x00, 0x06, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x80, 0x00, 0x00, 0x00, 0x00, 0x02, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x40, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x14, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0x0f, 0x76, 0x74, 0xbc, 0xd0, 0x28, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0x91, 0x49, 0x44, 0xa5, 0x30, 0x28, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x28, 0x00, 0x51, 0x49, 0x74, 0xa5, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x51, 0x49, 0x14, 0xa5, 0x30, 0x14, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x10, 0x01, 0xcf, 0x49, 0x73, 0xa4, 0xd0, 0x14, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x01, 0x30, 0x14, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x01, 0xe0, 0x0c, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x20, 0x01, 0x00, 0x00, 0x00, 0x20, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x20, 0x01, 0xf7, 0x9d, 0x2f, 0xf5, 0xce, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x20, 0x01, 0x8e, 0x62, 0xa9, 0xa6, 0x29, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x20, 0x01, 0x8c, 0x62, 0xa8, 0xa6, 0x21, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x20, 0x01, 0x8c, 0x56, 0x4d, 0xb7, 0x69, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x08, 0x04, 0x00, 0x80, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x10, 0x01, 0x32, 0xa9, 0x28, 0x16, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x28, 0x03, 0x04, 0xa6, 0xb6, 0x99, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x28, 0x02, 0x08, 0xa4, 0xa2, 0x96, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x28, 0x01, 0x1c, 0xa4, 0xa2, 0x91, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x14, 0x01, 0xe7, 0xa4, 0xbc, 0xff, 0x00, 0x68, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0xd0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x60, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x04, 0x80, 0x00, 0x00, 0x00, 0x00, 0x03, 0x40, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x80, 0x00, 0x00, 0x00, 0x00, 0x02, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x40, 0x00, 0x00, 0x00, 0x00, 0x05, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x36, 0x00, 0x00, 0x00, 0x00, 0xd8, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x09, 0x00, 0x00, 0x00, 0x01, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xc0, 0x00, 0x00, 0x06, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x30, 0x00, 0x00, 0x19, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xce, 0x00, 0x00, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x71, 0xe0, 0x07, 0x9c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x1f, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x0f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// -------------------------
// LOGO DIBIMBING BITMAP (128x64px)
// -------------------------
const unsigned char epd_bitmap_dibimbing [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0xc3, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0x81, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0x81, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0x81, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0xc1, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xc1, 0x99, 0x01, 0x80, 0x01, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x04, 0xe1, 0x89, 0x01, 0x80, 0x01, 0x81, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0e, 0x61, 0x81, 0x30, 0x0e, 0x61, 0xb0, 0x06, 0x04, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0c, 0x71, 0x99, 0x79, 0x9f, 0xf9, 0xf9, 0x9f, 0x1f, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0c, 0x31, 0x99, 0x9d, 0xb1, 0x99, 0x8d, 0x91, 0xb1, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0c, 0x19, 0x99, 0x0d, 0xb1, 0x89, 0x8d, 0xb1, 0xb1, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0c, 0x19, 0x99, 0x0d, 0xb1, 0x89, 0x8d, 0xb1, 0xb1, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0e, 0x0d, 0x99, 0x8d, 0xb1, 0x89, 0x8d, 0xb1, 0xb1, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x07, 0xee, 0x19, 0x99, 0xb1, 0x89, 0x8d, 0xb1, 0xb9, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x03, 0xf6, 0x19, 0xf9, 0xb1, 0x88, 0xf9, 0xb1, 0x9f, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};


// -------------------------
// DEFINISI PIN
// -------------------------
#define PIN_MERAH   14
#define PIN_KUNING  12
#define PIN_HIJAU   18
#define PIN_RELAY   25
#define PIN_BUZZER  26
#define DHTPIN      4
#define DHTTYPE     DHT11
#define PIN_MQ2     15    // MQ2 Gas Sensor Digital Output
#define PIN_SERVO   13    // Servo Motor for Door
#define PIN_BTN_DOOR 33   // Manual Button for Door Control

// LDR Light Control
#define PIN_LDR         32    // LDR Sensor (Analog Input)
#define PIN_LDR_RELAY   27    // Relay untuk lampu (dikontrol LDR)
#define PIN_LDR_BUTTON  5     // Button manual untuk lampu (prioritas)

// -------------------------
// WIFI & MQTT CONFIG
// -------------------------
const char* ssid = "SIC-UG";
const char* password = "jayajayajaya";
const char* mqtt_server = "broker.hivemq.com";

// Topics for DHT11 (Temperature/Humidity)
const char* topic_data = "final-project/Mahasiswa-Berpola-Pikir/smartcage/data";
const char* topic_prediction = "final-project/Mahasiswa-Berpola-Pikir/smartcage/prediction";

// Topics for MQ2 (Gas Sensor) - SEPARATE
const char* topic_gas_data = "final-project/Mahasiswa-Berpola-Pikir/smartcage/gas/data";
const char* topic_gas_prediction = "final-project/Mahasiswa-Berpola-Pikir/smartcage/gas/prediction";

// Topics for LDR (Light Sensor)
const char* topic_ldr_data = "final-project/Mahasiswa-Berpola-Pikir/smartcage/ldr/data";
const char* topic_ldr_prediction = "final-project/Mahasiswa-Berpola-Pikir/smartcage/ldr/prediction";

String clientId = "SmartCageESP32-" + String((uint32_t)ESP.getEfuseMac(), HEX);

WiFiClient espClient;
PubSubClient client(espClient);

// -------------------------
// OBJEK SENSOR & DISPLAY
// -------------------------
DHT dht(DHTPIN, DHTTYPE);
LiquidCrystal_I2C lcd(0x27, 16, 2);
Adafruit_SSD1306 oled(128, 64, &Wire, -1);

// -------------------------
// VARIABEL TIMER
// -------------------------
unsigned long previousMillisSensor = 0;
unsigned long previousMillisBlink = 0;
unsigned long previousMillisBuzzer = 0;
unsigned long previousMillisLCD = 0;

const long intervalSensor = 1500;   // Baca & publish sensor every 1.5s (safe for HiveMQ)
const long intervalBlink = 300;     // LED blink
const long intervalBuzzer = 500;    // Buzzer beep
const long intervalLCD = 100;       // LCD update

// -------------------------
// VARIABEL STATUS DHT11
// -------------------------
float suhu = 0.0;
float kelembapan = 0.0;
String mlPrediction = "Waiting";
float mlConfidence = 0.0;
bool ledBlinkState = LOW;
bool buzzerState = LOW;
String lastLcdLine1 = "";
String lastLcdLine2 = "";

// -------------------------
// VARIABEL STATUS MQ2 GAS
// -------------------------
bool gasDetected = false;           // MQ2 state (HIGH = gas detected)
String gasKondisi = "Aman";         // Aman, Waspada, Bahaya
String mlGasPrediction = "Waiting"; // ML gas prediction
float mlGasConfidence = 0.0;
bool gasLedBlinkState = LOW;
bool gasBuzzerState = LOW;
unsigned long previousMillisGasBlink = 0;
unsigned long previousMillisGasBuzzer = 0;

// -------------------------
// SERVO DOOR CONTROL
// -------------------------
Servo doorServo;
bool doorOpen = false;              // Current door state (false=closed, true=open)
int currentServoPos = 150;          // Current servo position (starts closed at 180)
unsigned long lastButtonPress = 0;  // Debounce timer
const long debounceDelay = 500;     // Button debounce delay
const int DOOR_CLOSED_POS = 135;    // Closed = 135 degrees
const int DOOR_OPEN_POS = 0;        // Open = 0 degrees

// -------------------------
// LDR + BUTTON CONTROL
// -------------------------
// Threshold untuk kondisi cahaya (ESP32 12-bit ADC: 0-4095)
// Berdasarkan sensor: Terang=0-1000, Gelap=4096
#define LDR_THRESHOLD_TERANG 1000   // 0-1000 = Terang (cahaya penuh)
#define LDR_THRESHOLD_REDUP  3000   // 1001-3000 = Redup (remang-remang)
                                    // 3001-4095 = Gelap (minim cahaya)

// LDR timing & state
unsigned long previousMillisLDR = 0;
const long intervalLDR = 100;       // Baca LDR setiap 100ms

// LDR button debounce
unsigned long ldrButtonDebounceTime = 0;
const long ldrButtonDebounceDelay = 50;
int lastLdrButtonState = HIGH;
int ldrButtonState = HIGH;
unsigned long ldrButtonPressStart = 0;

// LDR state
int ldrValue = 100;
String ldrCondition = "";
bool ldrRelayState = false;
bool ldrManualMode = false;   // true = button mengontrol relay lampu

// -------------------------
// SETUP WIFI
// -------------------------
void setup_wifi() {
  delay(10);
  Serial.println();
  Serial.print("Connecting to WiFi: ");
  Serial.println(ssid);
  
  WiFi.begin(ssid, password);
  
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println("\nWiFi connected!");
  Serial.print("IP address: ");
  Serial.println(WiFi.localIP());
}

// -------------------------
// MQTT CALLBACK (laporan)
// -------------------------
void callback(char* topic, byte* payload, unsigned int length) {
  StaticJsonDocument<256> doc;
  DeserializationError error = deserializeJson(doc, payload, length);
  
  if (error) {
    Serial.println("Failed to parse ML prediction!");
    return;
  }
  
  String topicStr = String(topic);
  
  // Check if it's DHT11 or Gas prediction
  if (topicStr == topic_prediction) {
    // DHT11 prediction
    String kondisi = doc["kondisi"];
    float confidence = doc["confidence"];
    
    mlPrediction = kondisi;
    mlConfidence = confidence;
    
    Serial.println("=== ML DHT11 PREDICTION ===");
    Serial.print("Kondisi: ");
    Serial.println(kondisi);
    Serial.print("Confidence: ");
    Serial.print(confidence);
    Serial.println("%");
  }
  else if (topicStr == topic_gas_prediction) {
    // Gas prediction
    String kondisi = doc["kondisi"];
    float confidence = doc["confidence"];
    
    mlGasPrediction = kondisi;
    mlGasConfidence = confidence;
    
    Serial.println("=== ML GAS PREDICTION ===");
    Serial.print("Kondisi: ");
    Serial.println(kondisi);
    Serial.print("Confidence: ");
    Serial.print(confidence);
    Serial.println("%");
  }
  else if (topicStr == topic_ldr_prediction) {
    // LDR prediction
    String kondisi = doc["kondisi"];
    float confidence = doc["confidence"];
    
    Serial.println("=== ML LDR PREDICTION ===");
    Serial.print("Kondisi: ");
    Serial.println(kondisi);
    Serial.print("Confidence: ");
    Serial.print(confidence);
    Serial.println("%");
    
    // Auto control relay based on ML prediction
    // Active-LOW relay: LOW=ON, HIGH=OFF
    if (!ldrManualMode) {
      if (kondisi == "Gelap" && !ldrRelayState) {
        ldrRelayState = true;
        digitalWrite(PIN_LDR_RELAY, LOW);  // Active-LOW: ON
        Serial.println("[ML] Light Relay ON (Gelap detected)");
      } else if (kondisi != "Gelap" && ldrRelayState) {
        ldrRelayState = false;
        digitalWrite(PIN_LDR_RELAY, HIGH);  // Active-LOW: OFF
        Serial.println("[ML] Light Relay OFF (Terang/Redup detected)");
      }
    }
  }
}

// -------------------------
// MQTT RECONNECT
// -------------------------
void reconnect() {
  while (!client.connected()) {
    Serial.print("Connecting to MQTT...");
    
    if (client.connect(clientId.c_str())) {
      Serial.println("connected!");
      
      // Subscribe to both prediction topics
      client.subscribe(topic_prediction);
      Serial.print("Subscribed: ");
      Serial.println(topic_prediction);
      
      client.subscribe(topic_gas_prediction);
      Serial.print("Subscribed: ");
      Serial.println(topic_gas_prediction);
      
      client.subscribe(topic_ldr_prediction);
      Serial.print("Subscribed: ");
      Serial.println(topic_ldr_prediction);
    } else {
      Serial.print("failed, rc=");
      Serial.print(client.state());
      Serial.println(" retrying in 2s");
      delay(2000);
    }
  }
}

// -------------------------
// SETUP (laporan) opsional
// -------------------------
void setup() {
  Serial.begin(115200);
  Wire.begin();
  
  // ===== OLED & LCD INITIALIZATION =====
  lcd.init();
  lcd.backlight();
  
  // Setup OLED first for logo display
  if (!oled.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("OLED init failed!");
  }
  oled.clearDisplay();
  oled.setTextColor(SSD1306_WHITE);
  
  // ===== STARTUP LOGO SEQUENCE (Before SmartCage ML Starting) =====
  
  // --- LOGO 1: GUNADARMA ---
  Serial.println("[STARTUP] Displaying Gunadarma Logo...");
  oled.clearDisplay();
  oled.drawBitmap(0, 0, epd_bitmap_gunadarma, 128, 64, SSD1306_WHITE);
  oled.display();
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("  Universitas");
  lcd.setCursor(0, 1);
  lcd.print("   Gunadarma");
  delay(3000);  // Show for 3 seconds
  
  // --- LOGO 2: SAMSUNG INNOVATION CAMPUS ---
  Serial.println("[STARTUP] Displaying SIC Logo...");
  oled.clearDisplay();
  oled.drawBitmap(0, 0, epd_bitmap_sic, 128, 64, SSD1306_WHITE);
  oled.display();
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Samsung");
  lcd.setCursor(0, 1);
  lcd.print("Innovation Camp");  // 16 chars max
  delay(3000);  // Show for 3 seconds
  
  // --- LOGO 3: DIBIMBING ---
  Serial.println("[STARTUP] Displaying Dibimbing Logo...");
  oled.clearDisplay();
  oled.drawBitmap(0, 0, epd_bitmap_dibimbing, 128, 64, SSD1306_WHITE);
  oled.display();
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("  dibimbing.id");
  lcd.setCursor(0, 1);
  lcd.print("");
  delay(3000);  // Show for 3 seconds
  
  // ===== NOW START MAIN INITIALIZATION =====
  // Show "SmartCage ML Starting" on both displays
  oled.clearDisplay();
  oled.setTextSize(1);
  oled.setCursor(0, 0);
  oled.println("=== SmartCage ML ===");
  oled.drawLine(0, 10, 127, 10, SSD1306_WHITE);
  oled.setCursor(0, 14);
  oled.println("Initializing...");
  oled.setCursor(0, 26);
  oled.println("DHT11:  [checking]");
  oled.setCursor(0, 36);
  oled.println("MQ2:    [checking]");
  oled.setCursor(0, 46);
  oled.println("LDR:    [checking]");
  oled.setCursor(0, 56);
  oled.println("SERVO:  [checking]");
  oled.display();
  
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("SmartCage ML");
  lcd.setCursor(0, 1);
  lcd.print("Starting...");
  delay(1000);
  
  // Step 2: Initialize Sensors
  dht.begin();
  
  // Setup pins
  pinMode(PIN_MERAH, OUTPUT);
  pinMode(PIN_KUNING, OUTPUT);
  pinMode(PIN_HIJAU, OUTPUT);
  pinMode(PIN_RELAY, OUTPUT);
  pinMode(PIN_BUZZER, OUTPUT);
  pinMode(PIN_MQ2, INPUT);
  pinMode(PIN_BTN_DOOR, INPUT_PULLUP);  // Button with internal pull-up
  
  // LDR Control pins
  pinMode(PIN_LDR_RELAY, OUTPUT);
  pinMode(PIN_LDR_BUTTON, INPUT_PULLUP);  // Button with internal pull-up
  digitalWrite(PIN_LDR_RELAY, HIGH);      // Active-LOW: HIGH=OFF, start with light OFF
  
  // Setup Servo - start at closed position
  doorServo.attach(PIN_SERVO);
  doorServo.write(DOOR_CLOSED_POS);
  currentServoPos = DOOR_CLOSED_POS;
  doorOpen = false;
  delay(300);
  
  // Default state
  digitalWrite(PIN_MERAH, LOW);
  digitalWrite(PIN_KUNING, LOW);
  digitalWrite(PIN_HIJAU, LOW);
  digitalWrite(PIN_RELAY, LOW);
  digitalWrite(PIN_BUZZER, LOW);
  
  // Check DHT11
  float testTemp = dht.readTemperature();
  bool dhtOk = !isnan(testTemp);
  
  // Check LDR sensor
  int testLdr = analogRead(PIN_LDR);
  bool ldrOk = (testLdr >= 0 && testLdr <= 4095);
  
  // Update OLED with sensor status (Ready/Not Ready)
  oled.clearDisplay();
  oled.setTextSize(1);
  oled.setCursor(0, 0);
  oled.println("=== SENSOR STATUS ===");
  oled.drawLine(0, 10, 127, 10, SSD1306_WHITE);
  oled.setCursor(0, 14);
  oled.print("DHT11:  ");
  oled.println(dhtOk ? "[READY]" : "[NOT READY]");
  oled.setCursor(0, 24);
  oled.print("MQ2:    ");
  oled.println("[READY]");
  oled.setCursor(0, 34);
  oled.print("LDR:    ");
  oled.println(ldrOk ? "[READY]" : "[NOT READY]");
  oled.setCursor(0, 44);
  oled.print("SERVO:  ");
  oled.println("[READY]");
  oled.drawLine(0, 53, 127, 53, SSD1306_WHITE);
  oled.setCursor(0, 56);
  oled.println("Connecting WiFi...");
  oled.display();
  
  // Update LCD with sensor status
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print(dhtOk ? "DHT11:READY" : "DHT11:FAIL");
  lcd.setCursor(0, 1);
  lcd.print("MQ2:READY LDR:");
  lcd.print(ldrOk ? "OK" : "X");
  delay(2000);
  
  Serial.println("=== SENSOR CHECK ===");
  Serial.print("DHT11: ");
  Serial.println(dhtOk ? "READY" : "NOT READY");
  Serial.println("MQ2: READY");
  Serial.print("LDR: ");
  Serial.print(ldrOk ? "READY" : "NOT READY");
  Serial.print(" (Val: ");
  Serial.print(testLdr);
  Serial.println(")");
  Serial.println("SERVO: READY");
  Serial.println("====================");
  
  // Step 4: Connect WiFi
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Connecting WiFi");
  lcd.setCursor(0, 1);
  lcd.print(ssid);
  
  WiFi.begin(ssid, password);
  int wifiAttempts = 0;
  while (WiFi.status() != WL_CONNECTED && wifiAttempts < 30) {
    delay(500);
    Serial.print(".");
    wifiAttempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi connected!");
    Serial.print("IP: ");
    Serial.println(WiFi.localIP());
    
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("WiFi Connected!");
    lcd.setCursor(0, 1);
    lcd.print(ssid);
    delay(1500);
  } else {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("WiFi FAILED!");
    delay(2000);
  }
  
  // Step 5: Connect MQTT
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Connecting MQTT");
  lcd.setCursor(0, 1);
  lcd.print("broker.hivemq");
  
  client.setServer(mqtt_server, 1883);
  client.setCallback(callback);
  
  // Try MQTT connection
  int mqttAttempts = 0;
  while (!client.connected() && mqttAttempts < 5) {
    if (client.connect(clientId.c_str())) {
      Serial.println("MQTT connected!");
      client.subscribe(topic_prediction);
      client.subscribe(topic_gas_prediction);
      
      lcd.clear();
      lcd.setCursor(0, 0);
      lcd.print("MQTT Connected!");
      lcd.setCursor(0, 1);
      lcd.print("Ready to GO!");
      delay(1500);
    } else {
      Serial.print("MQTT failed, rc=");
      Serial.println(client.state());
      mqttAttempts++;
      delay(1000);
    }
  }
  
  if (!client.connected()) {
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("MQTT FAILED!");
    lcd.setCursor(0, 1);
    lcd.print("Retry in loop");
    delay(2000);
  }
  
  // Step 6: All Ready!
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("System Ready!");
  lcd.setCursor(0, 1);
  lcd.print("ML+Gas Active");
  delay(2000);
  lcd.clear();
}

// -------------------------
// LOOP UTAMA (laporan)
// -------------------------
void loop() {
  // MQTT connection check
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  unsigned long currentMillis = millis();

  // ===================================================================
  // FASE 1: BACA SENSOR & PUBLISH (Every 2 detik)
  // ===================================================================
  if (currentMillis - previousMillisSensor >= intervalSensor) {
    previousMillisSensor = currentMillis;

    // Read DHT11
    suhu = dht.readTemperature();
    kelembapan = dht.readHumidity();

    if (!isnan(suhu) && !isnan(kelembapan)) {
      Serial.print("DHT11: T=");
      Serial.print(suhu);
      Serial.print("C, H=");
      Serial.print(kelembapan);
      Serial.println("%");

      // Publish DHT11 data
      StaticJsonDocument<256> doc;
      doc["temp"] = suhu;
      doc["humidity"] = kelembapan;

      char payload[256];
      serializeJson(doc, payload);
      client.publish(topic_data, payload);
    }

    // Read MQ2 - LOW = Gas Detected (standard MQ2 digital output)
    // Most MQ2 modules: LOW when gas detected, HIGH when no gas
    gasDetected = (digitalRead(PIN_MQ2) == LOW);
    
    // Determine gas kondisi
    // Aman: No gas (MQ2 HIGH)
    // Waspada: Gas detected (MQ2 LOW)
    // Bahaya: Gas detected + Suhu > 55°C (kebakaran)
    if (!gasDetected) {
      gasKondisi = "Aman";
    } else if (gasDetected && suhu > 55.0) {
      gasKondisi = "Bahaya";
    } else {
      gasKondisi = "Waspada";
    }

    Serial.print("MQ2: Gas=");
    Serial.print(gasDetected ? "YES" : "NO");
    Serial.print(", Status=");
    Serial.println(gasKondisi);

    // Publish Gas data
    StaticJsonDocument<256> gasDoc;
    gasDoc["gas_detected"] = gasDetected;
    gasDoc["temp"] = suhu;
    gasDoc["kondisi_lokal"] = gasKondisi;

    char gasPayload[256];
    serializeJson(gasDoc, gasPayload);
    client.publish(topic_gas_data, gasPayload);

    // Update OLED
    updateOLED();
  }

  // ===================================================================
  // FASE 2: TRIGGER OUTPUT BERDASARKAN ML PREDICTION (DHT11)
  // ===================================================================
  if (mlGasPrediction != "Bahaya" && mlGasPrediction != "Waspada") {
    // Only handle DHT11 if gas is safe
    if (mlPrediction == "Ideal") {
      handleIdeal(currentMillis);
    } 
    else if (mlPrediction == "Panas") {
      handlePanas(currentMillis);
    } 
    else if (mlPrediction == "Dingin") {
      handleDingin(currentMillis);
    }
    else {
      handleWaiting(currentMillis);
    }
  }

  // ===================================================================
  // FASE 3: TRIGGER OUTPUT BERDASARKAN ML PREDICTION (GAS)
  // Gas alerts override temperature alerts
  // ===================================================================
  if (mlGasPrediction == "Bahaya") {
    handleGasBahaya(currentMillis);
  }
  else if (mlGasPrediction == "Waspada") {
    handleGasWaspada(currentMillis);
  }

  // ===================================================================
  // FASE 4: UPDATE LCD
  // ===================================================================
  updateLCD(currentMillis);
  
  // ===================================================================
  // FASE 5: DOOR CONTROL (Button + Auto on Bahaya/Panas)
  // ===================================================================
  handleDoorControl(currentMillis);
  
  // ===================================================================
  // FASE 6: LDR LIGHT CONTROL (Button Manual + Auto)
  // ===================================================================
  handleLDRControl(currentMillis);
}

// ===================================================================
// FUNGSI HANDLER OUTPUT DHT11
// ===================================================================

void handleIdeal(unsigned long currentMillis) {
  digitalWrite(PIN_HIJAU, HIGH);
  digitalWrite(PIN_MERAH, LOW);
  digitalWrite(PIN_KUNING, LOW);
  digitalWrite(PIN_RELAY, LOW);
  digitalWrite(PIN_BUZZER, LOW);
}

void handlePanas(unsigned long currentMillis) {
  digitalWrite(PIN_HIJAU, LOW);
  digitalWrite(PIN_KUNING, LOW);
  
  if (currentMillis - previousMillisBlink >= intervalBlink) {
    previousMillisBlink = currentMillis;
    ledBlinkState = !ledBlinkState;
    digitalWrite(PIN_MERAH, ledBlinkState);
  }
  
  digitalWrite(PIN_RELAY, LOW);
  
  if (currentMillis - previousMillisBuzzer >= intervalBuzzer) {
    previousMillisBuzzer = currentMillis;
    buzzerState = !buzzerState;
    digitalWrite(PIN_BUZZER, buzzerState);
  }
}

void handleDingin(unsigned long currentMillis) {
  digitalWrite(PIN_HIJAU, LOW);
  digitalWrite(PIN_MERAH, LOW);
  
  if (currentMillis - previousMillisBlink >= intervalBlink) {
    previousMillisBlink = currentMillis;
    ledBlinkState = !ledBlinkState;
    digitalWrite(PIN_KUNING, ledBlinkState);
  }
  
  digitalWrite(PIN_RELAY, HIGH);
  
  if (currentMillis - previousMillisBuzzer >= intervalBuzzer) {
    previousMillisBuzzer = currentMillis;
    buzzerState = !buzzerState;
    digitalWrite(PIN_BUZZER, buzzerState);
  }
}

void handleWaiting(unsigned long currentMillis) {
  digitalWrite(PIN_HIJAU, LOW);
  digitalWrite(PIN_MERAH, LOW);
  digitalWrite(PIN_KUNING, LOW);
  digitalWrite(PIN_RELAY, LOW);
  digitalWrite(PIN_BUZZER, LOW);
}

// ===================================================================
// FUNGSI HANDLER OUTPUT GAS
// ===================================================================

void handleGasWaspada(unsigned long currentMillis) {
  digitalWrite(PIN_HIJAU, LOW);
  digitalWrite(PIN_MERAH, LOW);
  
  if (currentMillis - previousMillisGasBlink >= 400) {
    previousMillisGasBlink = currentMillis;
    gasLedBlinkState = !gasLedBlinkState;
    digitalWrite(PIN_KUNING, gasLedBlinkState);
  }
  
  if (currentMillis - previousMillisGasBuzzer >= 800) {
    previousMillisGasBuzzer = currentMillis;
    gasBuzzerState = !gasBuzzerState;
    digitalWrite(PIN_BUZZER, gasBuzzerState);
  }
}

void handleGasBahaya(unsigned long currentMillis) {
  digitalWrite(PIN_HIJAU, LOW);
  digitalWrite(PIN_KUNING, LOW);
  
  // LED Merah blink cepat
  if (currentMillis - previousMillisGasBlink >= 100) {
    previousMillisGasBlink = currentMillis;
    gasLedBlinkState = !gasLedBlinkState;
    digitalWrite(PIN_MERAH, gasLedBlinkState);
  }
  
  // Buzzer continuous
  digitalWrite(PIN_BUZZER, HIGH);
  
  // Relay ON (matikan kipas)
  digitalWrite(PIN_RELAY, HIGH);
}

// ===================================================================
// FUNGSI UPDATE DISPLAY
// ===================================================================

void updateOLED() {
  oled.clearDisplay();
  oled.setTextSize(1);
  oled.setCursor(0, 0);
  oled.println("SmartCage ML");
  oled.drawLine(0, 9, 127, 9, SSD1306_WHITE);
  
  // DHT11 Info (Line 11-19)
  oled.setCursor(0, 11);
  oled.print("T:");
  oled.print(suhu, 1);
  oled.print("C ");
  oled.print(mlPrediction);
  
  // Gas Info (Line 21-29)
  oled.setCursor(0, 21);
  oled.print("Gas:");
  oled.print(gasDetected ? "Y" : "N");
  oled.print(" ");
  oled.print(gasKondisi);
  
  oled.drawLine(0, 31, 127, 31, SSD1306_WHITE);
  
  // LDR Info (Line 33-41)
  oled.setCursor(0, 33);
  oled.print("LDR:");
  oled.print(ldrValue);
  oled.print(" ");
  oled.print(ldrCondition);
  
  // Light Status (Line 43-51)
  oled.setCursor(0, 43);
  oled.print("Light:");
  oled.print(ldrRelayState ? "ON" : "OFF");
  oled.print(" ");
  oled.print(ldrManualMode ? "[M]" : "[A]");
  
  // Humidity at bottom (Line 53-63)
  oled.setCursor(0, 55);
  oled.print("H:");
  oled.print(kelembapan, 0);
  oled.print("% ML:");
  oled.print(mlGasPrediction);
  
  oled.display();
}

void updateLCD(unsigned long currentMillis) {
  if (currentMillis - previousMillisLCD >= intervalLCD) {
    previousMillisLCD = currentMillis;
    
    // Rotate between 3 screens: DHT11, Gas, LDR (every 2 seconds)
    int screenNum = (currentMillis / 2000) % 3;
    
    String line1, line2;
    
    if (screenNum == 0) {
      // Screen 1: DHT11 Temperature & Humidity
      line1 = "T:" + String(suhu, 1) + "C H:" + String(kelembapan, 0) + "%";
      line2 = "ML:" + mlPrediction;
    } 
    else if (screenNum == 1) {
      // Screen 2: Gas Sensor
      line1 = "Gas:" + String(gasDetected ? "Y" : "N") + " " + gasKondisi;
      line2 = "ML:" + mlGasPrediction;
    }
    else {
      // Screen 3: LDR Light Control Status
      String ldrMode = ldrManualMode ? "MANUAL" : "AUTO";
      line1 = "Light:" + ldrMode;
      line2 = "LDR:" + String(ldrValue) + " " + (ldrRelayState ? "ON" : "OFF");
    }
    
    if (line1 != lastLcdLine1 || line2 != lastLcdLine2) {
      lcd.setCursor(0, 0);
      lcd.print("                ");
      lcd.setCursor(0, 0);
      lcd.print(line1);
      
      lcd.setCursor(0, 1);
      lcd.print("                ");
      lcd.setCursor(0, 1);
      lcd.print(line2);
      
      lastLcdLine1 = line1;
      lastLcdLine2 = line2;
    }
  }
}

// ===================================================================
// FUNGSI DOOR CONTROL (SERVO) - Fast Movement
// ===================================================================

// Open door: move servo from closed to open position (fast)
void openDoor() {
  if (!doorOpen) {
    Serial.println("Opening door... (135 -> 0)");
    for (int pos = currentServoPos; pos >= DOOR_OPEN_POS; pos--) {
      doorServo.write(pos);
      delay(1);  // Fast movement speed (was 15ms)
    }
    currentServoPos = DOOR_OPEN_POS;
    doorOpen = true;
    Serial.println("Door OPENED");
  }
}

// Close door: move servo from open to closed position (fast)
void closeDoor() {
  if (doorOpen) {
    Serial.println("Closing door... (0 -> 135)");
    for (int pos = currentServoPos; pos <= DOOR_CLOSED_POS; pos++) {
      doorServo.write(pos);
      delay(1);  // Fast movement speed (was 15ms)
    }
    currentServoPos = DOOR_CLOSED_POS;
    doorOpen = false;
    Serial.println("Door CLOSED");
  }
}

// Main door control handler
void handleDoorControl(unsigned long currentMillis) {
  // ===== MANUAL BUTTON CHECK =====
  // Button is active LOW (INPUT_PULLUP: pressed = LOW)
  if (digitalRead(PIN_BTN_DOOR) == LOW) {
    // Debounce check - only trigger once per press
    if (currentMillis - lastButtonPress >= debounceDelay) {
      lastButtonPress = currentMillis;
      
      // Toggle door state
      if (doorOpen) {
        closeDoor();
      } else {
        openDoor();
      }
    }
  }
  
  // ===== AUTOMATIC OPEN ON BAHAYA OR PANAS =====
  // Auto-open door for emergency (Bahaya gas or Panas temperature)
  if (!doorOpen) {
    if (mlGasPrediction == "Bahaya" || mlPrediction == "Panas") {
      Serial.println("AUTO: Emergency detected - Opening door!");
      openDoor();
    }
  }
}

// ===================================================================
// FUNGSI LDR LIGHT CONTROL (Button Priority + Auto)
// ===================================================================

void handleLDRControl(unsigned long currentMillis) {
  // ===== HANDLE BUTTON DENGAN DEBOUNCE =====
  int reading = digitalRead(PIN_LDR_BUTTON);
  
  if (reading != lastLdrButtonState) {
    ldrButtonDebounceTime = currentMillis;
  }
  
  if ((currentMillis - ldrButtonDebounceTime) > ldrButtonDebounceDelay) {
    if (reading != ldrButtonState) {
      ldrButtonState = reading;
      
      // Button ditekan (LOW karena INPUT_PULLUP)
      if (ldrButtonState == LOW) {
        // Aktifkan manual mode dan toggle relay
        ldrManualMode = true;
        ldrRelayState = !ldrRelayState;  // Toggle ON/OFF
        // Active-LOW relay: LOW=ON, HIGH=OFF
        digitalWrite(PIN_LDR_RELAY, ldrRelayState ? LOW : HIGH);
        
        Serial.println("\n****************************************");
        Serial.println(">>> LDR BUTTON PRESSED - MANUAL MODE");
        Serial.print(">>> Light Relay: ");
        Serial.println(ldrRelayState ? "ON" : "OFF");
        Serial.println("****************************************\n");
      }
    }
  }
  lastLdrButtonState = reading;
  
  // ===== LONG PRESS UNTUK KEMBALI KE AUTO MODE =====
  if (ldrButtonState == LOW) {
    if (ldrButtonPressStart == 0) {
      ldrButtonPressStart = currentMillis;
    } else if ((currentMillis - ldrButtonPressStart) > 3000) {
      // Long press 3 detik -> kembali ke Auto
      ldrManualMode = false;
      ldrButtonPressStart = 0;
      Serial.println("\n========================================");
      Serial.println(">>> LDR KEMBALI KE AUTO MODE");
      Serial.println("========================================\n");
    }
  } else {
    ldrButtonPressStart = 0;
  }
  
  // ===== BACA LDR DAN KONTROL RELAY =====
  if (currentMillis - previousMillisLDR >= intervalLDR) {
    previousMillisLDR = currentMillis;
    
    ldrValue = analogRead(PIN_LDR);
    
    bool ldrWantsRelayOn;
    
    if (ldrValue <= LDR_THRESHOLD_TERANG) {
      ldrCondition = "Terang";
      ldrWantsRelayOn = false;  // Terang = Lampu OFF
    } 
    else if (ldrValue <= LDR_THRESHOLD_REDUP) {
      ldrCondition = "Redup";
      ldrWantsRelayOn = false;  // Redup = Lampu OFF
    } 
    else {
      ldrCondition = "Gelap";
      ldrWantsRelayOn = true;   // Gelap = Lampu ON
    }
    
    // Update relay HANYA jika AUTO mode (bukan manual)
    // Active-LOW relay: LOW=ON, HIGH=OFF
    if (!ldrManualMode) {
      if (ldrWantsRelayOn != ldrRelayState) {
        ldrRelayState = ldrWantsRelayOn;
        digitalWrite(PIN_LDR_RELAY, ldrRelayState ? LOW : HIGH);
        
        Serial.println("----------------------------------------");
        Serial.print("[LDR AUTO] Light Relay ");
        Serial.println(ldrRelayState ? "ON! (Gelap)" : "OFF!");
        Serial.println("----------------------------------------");
      }
    }
    
    // Print status setiap 1 detik (10 iterasi @ 100ms)
    static int ldrPrintCount = 0;
    ldrPrintCount++;
    if (ldrPrintCount >= 10) {
      ldrPrintCount = 0;
      Serial.print("[LDR ");
      Serial.print(ldrManualMode ? "MANUAL" : "AUTO");
      Serial.print("] Val:");
      Serial.print(ldrValue);
      Serial.print(" | ");
      Serial.print(ldrCondition);
      Serial.print(" | Light:");
      Serial.println(ldrRelayState ? "ON" : "OFF");
      
      // Publish LDR data to MQTT
      StaticJsonDocument<256> ldrDoc;
      ldrDoc["ldr_value"] = ldrValue;
      ldrDoc["kondisi_lokal"] = ldrCondition;
      ldrDoc["manual_mode"] = ldrManualMode;
      ldrDoc["relay_state"] = ldrRelayState;
      
      char ldrPayload[256];
      serializeJson(ldrDoc, ldrPayload);
      client.publish(topic_ldr_data, ldrPayload);
    }
  }
}